<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Solicitud de Prórrogas - Adipa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; padding: 20px; }
    .container { max-width: 620px; margin: auto; background: #ffffff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    img.logo { width: 160px; display: block; margin: 0 auto 25px; }
    h1 { font-size: 22px; margin-bottom: 25px; text-align: center; color: #333; }
    label { font-weight: bold; margin-top: 18px; display: block; color: #444; }
    input, select, button, textarea { width: 100%; padding: 10px; margin-top: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }
    input, select, button { height: 45px; }
    select[multiple] { height: auto; min-height: 120px; border: 1px solid #704EFD; }
    textarea { height: 140px; resize: vertical; font-family: inherit; background: #f9f9f9; border: 1px solid #704EFD; line-height: 1.5; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #704EFD; box-shadow: 0 0 5px rgba(112, 78, 253, 0.2); }
    
    button { background-color: #704EFD; color: white; border: none; cursor: pointer; margin-top: 20px; font-weight: bold; transition: all 0.3s; }
    button:hover:not(:disabled) { background-color: #5a3ecf; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    
    .btn-copiar { background-color: #28a745; margin-top: 10px; }
    .btn-copiar:hover { background-color: #218838; }
    .btn-copiado { background-color: #333 !important; }

    .mensaje { margin-top: 20px; font-size: 14px; text-align: center; font-weight: 500; }
    .info-nota { font-size: 12px; color: #666; font-style: italic; margin-top: 5px; }
    .hidden { display: none; }
    .resultado-box { margin-top: 20px; padding: 15px; border: 2px dashed #704EFD; border-radius: 8px; background: #f4f1ff; }
    .btn-secundario { background-color: #f4f1ff; color: #704EFD; border: 1px solid #704EFD; margin-top: 15px; }
  </style>
</head>

<body>

  <img src="https://aula.adipa.cl/pluginfile.php/1/theme_mb2nl/logo/1732710878/LOGOADIPA%202%20%283%29%20%281%29.png" alt="Logo de ADIPA" class="logo">

  <div class="container">
    <h1>Solicitud de Prórrogas</h1>

    <label for="email">Correo electrónico</label>
    <input type="email" id="email" placeholder="Ingresa el correo registrado en Adipa" required>

    <label for="tipoProrroga">Tipo de Prórroga</label>
    <select id="tipoProrroga" onchange="limpiarPantalla()">
      <option value="">-- Selecciona una opción --</option>
      <option value="prorroga_evaluacion">Evaluaciones</option>
      <option value="prorroga_material">Descarga de material</option>
    </select>

    <div id="extraEvaluacion" class="hidden">
        <label for="tipoPrograma">Tipo de Programa</label>
        <select id="tipoPrograma" onchange="toggleBotonBuscar()">
            <option value="curso">Curso</option>
            <option value="diplomado">Diplomado</option>
        </select>
    </div>

    <button id="btnBuscar" onclick="buscarProgramas()">Buscar programas</button>

    <div id="contenedorCursos" class="hidden" style="margin-top: 30px; border-top: 2px solid #eee; padding-top: 10px;">
      
      <label for="curso">Selecciona el Programa</label>
      <select id="curso"></select>

      <button id="btnBuscarModulos" class="btn-secundario hidden" onclick="buscarModulosDiplomado()">Buscar módulos del programa</button>

      <div id="divModulo" class="hidden">
          <label id="labelModulo" for="modulo">Módulos pendientes</label>
          <div id="wrapperModulo">
              </div>
          <p class="info-nota">Mantén presionado Ctrl (Windows) o Command (Mac) para seleccionar varios.</p>
      </div>

      <div id="divDias">
          <label for="dias">Días de prórroga</label>
          <select id="dias"></select>
          <p id="notaDias" class="info-nota"></p>
      </div>

      <button id="btnEnviarFinal" onclick="enviarSolicitudFinal()">Gestionar Prórroga</button>
    </div>

    <div class="mensaje" id="mensaje"></div>

    <div id="resultadoFinal" class="hidden resultado-box">
        <label style="margin-top: 0; color: #704EFD;">Respuesta para el estudiante:</label>
        <textarea id="textoRespuesta"></textarea>
        
        <button id="btnCopiar" class="btn-copiar" onclick="copiarTexto()">Copiar Mensaje</button>
        <button onclick="location.reload()" style="background-color: #666; margin-top: 10px;">Hacer otra solicitud</button>
    </div>
  </div>

  <script>
    const WEBHOOK_BUSCAR = "https://hook.us2.make.com/k6n5v5l2brwcfe3ab14t3s4rwojl1akg";
    const WEBHOOK_MODULOS = "https://hook.us2.make.com/aldugdre15ahx9lhq9kldnt50nzmqocr";
    const WEBHOOK_ENVIAR = "https://hook.us2.make.com/tkiwujry2rm5llcu4jbu7u7qgy8u23qv"; 

    function limpiarPantalla() {
        const tipo = document.getElementById("tipoProrroga").value;
        document.getElementById("contenedorCursos").classList.add("hidden");
        document.getElementById("resultadoFinal").classList.add("hidden");
        document.getElementById("mensaje").textContent = "";
        document.getElementById("btnEnviarFinal").classList.remove("hidden");
        document.getElementById("btnEnviarFinal").disabled = false;
        
        if (tipo === "prorroga_evaluacion") {
            document.getElementById("extraEvaluacion").classList.remove("hidden");
        } else {
            document.getElementById("extraEvaluacion").classList.add("hidden");
        }
        toggleBotonBuscar();
    }

    function toggleBotonBuscar() {
        const tipoProg = document.getElementById("tipoPrograma").value;
        const tipoProrroga = document.getElementById("tipoProrroga").value;
        const btnModulos = document.getElementById("btnBuscarModulos");
        const divMod = document.getElementById("divModulo");

        // Reset inicial: ocultamos ambos
        btnModulos.classList.add("hidden");
        divMod.classList.add("hidden");

        // Lógica: Solo diplomado muestra botón de búsqueda de módulos
        if (tipoProrroga === "prorroga_evaluacion" && tipoProg === "diplomado") {
            btnModulos.classList.remove("hidden");
        }
        // Para Curso, divMod se mantiene oculto (comportamiento original)
    }

    async function buscarProgramas() {
      const email = document.getElementById("email").value.trim();
      const tipoProrroga = document.getElementById("tipoProrroga").value;
      const tipoPrograma = document.getElementById("tipoPrograma").value;
      const mensaje = document.getElementById("mensaje");
      const boton = document.getElementById("btnBuscar");

      if (!email || !tipoProrroga) {
        mensaje.textContent = "Por favor, completa el correo y el tipo de prórroga.";
        mensaje.style.color = "red";
        return;
      }

      mensaje.textContent = "Buscando inscripciones...";
      mensaje.style.color = "#666";
      boton.disabled = true;

      try {
        const response = await fetch(WEBHOOK_BUSCAR, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
              email: email, 
              tipo_prorroga: tipoProrroga,
              tipo_programa: tipoProrroga === "prorroga_material" ? "curso" : tipoPrograma 
          })
        });

        const data = await response.json(); 
        let listaCursos = [];
        if (data.cursos) {
            listaCursos = Array.isArray(data.cursos) ? data.cursos : data.cursos.split(',').map(c => c.trim().replace(/[\[\]"']/g, ""));
        }

        if (listaCursos.length === 0) throw new Error();
        
        const selectCursos = document.getElementById("curso");
        selectCursos.innerHTML = "";
        listaCursos.forEach(c => {
          if(c) {
            let opt = document.createElement("option");
            opt.value = c; 
            opt.textContent = c;
            selectCursos.appendChild(opt);
          }
        });

        const selectDias = document.getElementById("dias");
        const nota = document.getElementById("notaDias");
        selectDias.innerHTML = "";
        
        if (tipoProrroga === "prorroga_material") {
            [1, 2].forEach(d => {
                let opt = document.createElement("option");
                opt.value = d; opt.textContent = d + (d === 1 ? " día" : " días");
                selectDias.appendChild(opt);
            });
            nota.textContent = "Máximo 2 días para descarga de material.";
        } else {
            [3, 5, 7, 10].forEach(d => {
                let opt = document.createElement("option");
                opt.value = d; opt.textContent = d + " días";
                selectDias.appendChild(opt);
            });
            nota.textContent = "Plazos estándar para evaluaciones: 7 días.";
        }

        document.getElementById("contenedorCursos").classList.remove("hidden");
        toggleBotonBuscar();
        mensaje.textContent = "¡Programas encontrados!";
        mensaje.style.color = "green";

      } catch (e) {
        mensaje.textContent = "No se encontraron programas activos para este correo.";
        mensaje.style.color = "red";
      } finally { boton.disabled = false; }
    }

    async function buscarModulosDiplomado() {
        const email = document.getElementById("email").value.trim();
        const programa = document.getElementById("curso").value;
        const mensaje = document.getElementById("mensaje");
        const btnModulos = document.getElementById("btnBuscarModulos");

        mensaje.textContent = "Buscando módulos pendientes...";
        mensaje.style.color = "#666";
        btnModulos.disabled = true;

        try {
            const res = await fetch(WEBHOOK_MODULOS, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email: email, nombre_programa: programa })
            });

            const modulos = await res.json();
            
            if (modulos && modulos.length > 0) {
                const divMod = document.getElementById("divModulo");
                const wrapper = document.getElementById("wrapperModulo");
                
                let selectHtml = '<select id="modulo_select" multiple>';
                modulos.forEach(m => {
                    // Soporta tanto array de strings como array de objetos {nombre: "..."}
                    let val = (typeof m === 'object') ? m.nombre : m;
                    selectHtml += `<option value="${val}">${val}</option>`;
                });
                selectHtml += '</select>';
                
                wrapper.innerHTML = selectHtml;
                divMod.classList.remove("hidden");
                mensaje.textContent = "Módulos cargados exitosamente.";
                mensaje.style.color = "green";
            } else {
                throw new Error();
            }
        } catch (e) {
            mensaje.textContent = "No se encontraron módulos pendientes.";
            mensaje.style.color = "red";
        } finally { btnModulos.disabled = false; }
    }

    async function enviarSolicitudFinal() {
      const mensaje = document.getElementById("mensaje");
      const btnFinal = document.getElementById("btnEnviarFinal");
      const resBox = document.getElementById("resultadoFinal");
      const resText = document.getElementById("textoRespuesta");
      
      const tipoProg = document.getElementById("tipoPrograma").value;
      const tipoProrroga = document.getElementById("tipoProrroga").value;
      
      let modulosSeleccionados = "Completo";

      // Lógica para capturar módulos si es Diplomado
      if (tipoProrroga === "prorroga_evaluacion" && tipoProg === "diplomado") {
          const selectM = document.getElementById("modulo_select");
          if (!selectM) {
              mensaje.textContent = "Primero debes buscar y seleccionar los módulos.";
              mensaje.style.color = "red";
              return;
          }
          const seleccionados = Array.from(selectM.selectedOptions).map(opt => opt.value);
          if (seleccionados.length === 0) {
              mensaje.textContent = "Selecciona al menos un módulo.";
              mensaje.style.color = "red";
              return;
          }
          modulosSeleccionados = seleccionados.join(", ");
      }

      const payload = {
        email: document.getElementById("email").value.trim(),
        tipo_prorroga: tipoProrroga,
        tipo_programa: tipoProrroga === "prorroga_material" ? "curso" : tipoProg,
        programa: document.getElementById("curso").value,
        modulo: modulosSeleccionados,
        dias_adicionales: document.getElementById("dias").value,
        fecha_solicitud: new Date().toLocaleString()
      };

      mensaje.textContent = "Gestionando la prórroga...";
      mensaje.style.color = "#704EFD";
      btnFinal.disabled = true;

      try {
        const res = await fetch(WEBHOOK_ENVIAR, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (res.ok) {
          mensaje.innerHTML = "<strong>¡Se ha gestionado con éxito!</strong>";
          mensaje.style.color = "green";
          resBox.classList.remove("hidden");
          resText.value = data.respuesta || "Prórroga gestionada correctamente.";
          btnFinal.classList.add("hidden"); 
        } else { throw new Error(); }

      } catch (e) {
        mensaje.textContent = "Error al conectar con el servidor.";
        mensaje.style.color = "red";
        btnFinal.disabled = false;
      }
    }

    function copiarTexto() {
      const texto = document.getElementById("textoRespuesta");
      const btnCopiar = document.getElementById("btnCopiar");
      texto.select();
      navigator.clipboard.writeText(texto.value).then(() => {
        const originalText = btnCopiar.innerText;
        btnCopiar.innerText = "¡Copiado!";
        btnCopiar.classList.add("btn-copiado");
        setTimeout(() => {
          btnCopiar.innerText = originalText;
          btnCopiar.classList.remove("btn-copiado");
        }, 1500);
      });
    }
  </script>
</body>
</html>
