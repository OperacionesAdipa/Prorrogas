<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Solicitud de Prórrogas - Adipa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; padding: 20px; }
    .container { max-width: 620px; margin: auto; background: #ffffff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    img.logo { width: 160px; display: block; margin: 0 auto 25px; }
    h1 { font-size: 22px; margin-bottom: 25px; text-align: center; color: #333; }
    label { font-weight: bold; margin-top: 18px; display: block; color: #444; }
    input, select, button { width: 100%; padding: 10px; margin-top: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; height: 45px; }
    input:focus, select:focus { outline: none; border-color: #704EFD; box-shadow: 0 0 5px rgba(112, 78, 253, 0.2); }
    button { background-color: #704EFD; color: white; border: none; cursor: pointer; margin-top: 20px; font-weight: bold; transition: background 0.3s; }
    button:hover:not(:disabled) { background-color: #5a3ecf; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    .mensaje { margin-top: 20px; font-size: 14px; text-align: center; font-weight: 500; }
    .info-nota { font-size: 12px; color: #666; font-style: italic; margin-top: 5px; }
    .hidden { display: none; }
  </style>
</head>

<body>

  <img src="https://aula.adipa.cl/pluginfile.php/1/theme_mb2nl/logo/1732710878/LOGOADIPA%202%20%283%29%20%281%29.png" alt="Logo de ADIPA" class="logo">

  <div class="container">
    <h1>Solicitud de Prórrogas</h1>

    <label for="email">Correo electrónico</label>
    <input type="email" id="email" placeholder="Ingresa el correo registrado en Adipa" required>

    <label for="tipoProrroga">Tipo de Prórroga</label>
    <select id="tipoProrroga" onchange="limpiarPantalla()">
      <option value="">-- Selecciona una opción --</option>
      <option value="prorroga_evaluacion">Prórroga evaluaciones</option>
      <option value="prorroga_material">Prórroga descarga de material</option>
    </select>

    <div id="extraEvaluacion" class="hidden">
        <label for="tipoPrograma">Tipo de Programa</label>
        <select id="tipoPrograma" onchange="toggleModulo()">
            <option value="curso">Curso</option>
            <option value="diplomado">Diplomado</option>
        </select>
    </div>

    <button id="btnBuscar" onclick="buscarProgramas()">Buscar programas</button>

    <div id="contenedorCursos" class="hidden" style="margin-top: 30px; border-top: 2px solid #eee; padding-top: 10px;">
      
      <label for="curso">Selecciona el Programa</label>
      <select id="curso"></select>

      <div id="divModulo" class="hidden">
          <label for="modulo">N° Módulo</label>
          <input type="text" id="modulo" placeholder="Ej: 2">
      </div>

      <div id="divDias">
          <label for="dias">Días de prórroga</label>
          <select id="dias"></select>
          <p id="notaDias" class="info-nota"></p>
      </div>

      <button id="btnEnviarFinal" onclick="enviarSolicitudFinal()">Gestionar Prórroga</button>
    </div>

    <div class="mensaje" id="mensaje"></div>
  </div>

  <script>
    const WEBHOOK_BUSCAR = "https://hook.us2.make.com/k6n5v5l2brwcfe3ab14t3s4rwojl1akg";
    const WEBHOOK_ENVIAR = "https://hook.us2.make.com/tkiwujry2rm5llcu4jbu7u7qgy8u23qv"; 

    function limpiarPantalla() {
        const tipo = document.getElementById("tipoProrroga").value;
        document.getElementById("contenedorCursos").classList.add("hidden");
        document.getElementById("mensaje").textContent = "";
        
        if (tipo === "prorroga_evaluacion") {
            document.getElementById("extraEvaluacion").classList.remove("hidden");
        } else {
            document.getElementById("extraEvaluacion").classList.add("hidden");
        }
        toggleModulo(); // Asegura que el módulo se oculte si cambiamos a material
    }

    function toggleModulo() {
        const tipoProrroga = document.getElementById("tipoProrroga").value;
        const tipoProg = document.getElementById("tipoPrograma").value;
        const divMod = document.getElementById("divModulo");
        
        // Solo mostrar módulo si es Evaluación Y Diplomado
        if (tipoProrroga === "prorroga_evaluacion" && tipoProg === "diplomado") {
            divMod.classList.remove("hidden");
        } else {
            divMod.classList.add("hidden");
        }
    }

    async function buscarProgramas() {
      const email = document.getElementById("email").value.trim();
      const tipoProrroga = document.getElementById("tipoProrroga").value;
      const mensaje = document.getElementById("mensaje");
      const boton = document.getElementById("btnBuscar");

      if (!email || !tipoProrroga) {
        mensaje.textContent = "Por favor, completa el correo y el tipo de prórroga.";
        mensaje.style.color = "red";
        return;
      }

      mensaje.textContent = "Buscando inscripciones...";
      mensaje.style.color = "#666";
      boton.disabled = true;

      try {
        const response = await fetch(WEBHOOK_BUSCAR, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: email, tipo_prorroga: tipoProrroga })
        });

        const data = await response.json(); 
        let listaCursos = [];
        if (data.cursos) {
            listaCursos = Array.isArray(data.cursos) ? data.cursos : data.cursos.split(',').map(c => c.trim().replace(/[\[\]"']/g, ""));
        }

        if (listaCursos.length === 0) throw new Error();
        
        const selectCursos = document.getElementById("curso");
        selectCursos.innerHTML = "";
        listaCursos.forEach(c => {
          if(c) {
            let opt = document.createElement("option");
            opt.value = c; 
            opt.textContent = c;
            selectCursos.appendChild(opt);
          }
        });

        const selectDias = document.getElementById("dias");
        const nota = document.getElementById("notaDias");
        selectDias.innerHTML = "";
        
        if (tipoProrroga === "prorroga_material") {
            [1, 2].forEach(d => {
                let opt = document.createElement("option");
                opt.value = d; opt.textContent = d + (d === 1 ? " día" : " días");
                selectDias.appendChild(opt);
            });
            nota.textContent = "Máximo 2 días para descarga de material.";
        } else {
            [3, 5, 7, 10].forEach(d => {
                let opt = document.createElement("option");
                opt.value = d; opt.textContent = d + " días";
                selectDias.appendChild(opt);
            });
            nota.textContent = "Plazos estándar para evaluaciones: 7 días.";
        }

        document.getElementById("contenedorCursos").classList.remove("hidden");
        toggleModulo(); // Re-validar visibilidad del módulo al mostrar el contenedor
        mensaje.textContent = "¡Programas encontrados!";
        mensaje.style.color = "green";

      } catch (e) {
        mensaje.textContent = "No se encontraron programas activos para este correo.";
        mensaje.style.color = "red";
      } finally { boton.disabled = false; }
    }

    async function enviarSolicitudFinal() {
      const mensaje = document.getElementById("mensaje");
      const btnFinal = document.getElementById("btnEnviarFinal");

      const payload = {
        email: document.getElementById("email").value.trim(),
        tipo_prorroga: document.getElementById("tipoProrroga").value,
        tipo_programa: document.getElementById("tipoPrograma").value || "n/a",
        programa: document.getElementById("curso").value,
        modulo: document.getElementById("modulo").value || "Completo",
        dias_adicionales: document.getElementById("dias").value,
        fecha_solicitud: new Date().toLocaleString()
      };

      mensaje.textContent = "Procesando prórroga...";
      mensaje.style.color = "#666";
      btnFinal.disabled = true;

      try {
        const res = await fetch(WEBHOOK_ENVIAR, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          mensaje.innerHTML = "<strong>¡Prórroga gestionada con éxito!</strong>";
          mensaje.style.color = "green";
          setTimeout(() => { location.reload(); }, 3000); 
        } else { throw new Error(); }
      } catch (e) {
        mensaje.textContent = "Error al conectar con el servidor.";
        mensaje.style.color = "red";
        btnFinal.disabled = false;
      }
    }
  </script>
</body>
</html>
